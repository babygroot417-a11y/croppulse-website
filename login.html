<script>
  // ===== Firebase Setup =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // ===== reCAPTCHA =====
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'invisible'
  });
  recaptchaVerifier.render();

  // ===== DOM Elements =====
  const phoneInput = document.getElementById('phone');
  const otpInput = document.getElementById('otp');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const resendOtpBtn = document.getElementById('resendOtpBtn');
  const phoneSection = document.getElementById('phone-section');
  const otpSection = document.getElementById('otp-section');
  const statusDiv = document.getElementById('status');

  let confirmationResultGlobal;
  let countdownInterval;
  let phoneNumberGlobal;

  // ===== Functions =====
  function startResendCountdown(autoTrigger = true) {
    let timeLeft = 30;
    resendOtpBtn.disabled = true;
    resendOtpBtn.textContent = `Resend OTP (${timeLeft}s)`;

    countdownInterval = setInterval(async () => {
      timeLeft--;
      resendOtpBtn.textContent = `Resend OTP (${timeLeft}s)`;
      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        resendOtpBtn.disabled = false;
        resendOtpBtn.textContent = 'Resend OTP';

        // Auto-resend OTP if user hasn't verified yet
        if (autoTrigger && otpSection.style.display === 'block') {
          await sendOTP(phoneNumberGlobal, true);
        }
      }
    }, 1000);
  }

  async function sendOTP(phoneNumber, isAuto = false) {
    try {
      const appVerifier = window.recaptchaVerifier;
      const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
      confirmationResultGlobal = confirmationResult;
      phoneNumberGlobal = phoneNumber;
      phoneSection.style.display = 'none';
      otpSection.style.display = 'block';
      statusDiv.textContent = isAuto ? 'OTP resent automatically! Check your phone.' : 'OTP sent! Check your phone.';
      startResendCountdown();
    } catch (err) {
      console.error(err);
      alert('Error sending OTP: ' + (err.message || err));
      window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
    }
  }

  // ===== Send OTP Button =====
  sendOtpBtn.addEventListener('click', async () => {
    const phoneNumber = phoneInput.value.trim();
    if (!phoneNumber) return alert('Enter phone number in international format (+91xxxxxxx)');
    await sendOTP(phoneNumber, false);
  });

  // ===== Verify OTP =====
  verifyOtpBtn.addEventListener('click', async () => {
    const code = otpInput.value.trim();
    if (!code) return alert('Enter OTP');

    try {
      const result = await confirmationResultGlobal.confirm(code);
      const user = result.user;
      statusDiv.textContent = 'Phone verified! UID: ' + user.uid;
      // TODO: Redirect or store session
    } catch (err) {
      console.error(err);
      alert('Invalid OTP: ' + (err.message || err));
    }
  });

  // ===== Resend OTP Button =====
  resendOtpBtn.addEventListener('click', async () => {
    if (!phoneNumberGlobal) return;
    await sendOTP(phoneNumberGlobal, false);
  });
</script>
