<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login / Sign Up - CropPulse</title>
  <meta name="description" content="Sign up or login to CropPulse to access smart crop advisory services with drone scanning technology.">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="assets/logo.png" type="image/png">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="script.js" defer></script>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">
        <img src="assets/logo.png" alt="CropPulse Logo">
        <span>CropPulse</span>
      </a>
      <nav>
        <a href="index.html">‚Üê Back to Home</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="flex-center" style="min-height: calc(100vh - 200px);">
      <div class="card" style="max-width: 500px; width: 100%;">
        <div class="text-center mb-4">
          <h1>Welcome to CropPulse</h1>
          <p class="text-secondary">Sign in to access your smart farming dashboard</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm">
          <div class="form-group">
            <label class="form-label" for="phone">Phone Number</label>
            <input 
              type="tel" 
              id="phone" 
              class="form-input" 
              placeholder="+91 9876543210"
              pattern="[+]?[0-9\s\-\(\)]+"
              required
            >
            <small class="text-secondary">Enter your 10-digit mobile number with country code</small>
          </div>

          <div id="recaptcha-container" class="mb-3"></div>

          <button type="button" onclick="sendOTP()" class="btn w-full mb-3" id="sendOtpBtn">
            <span id="sendOtpText">Send OTP</span>
            <span id="sendOtpLoading" class="loading hidden"></span>
          </button>

          <div class="text-center">
            <p class="text-secondary">We'll send you a verification code via SMS</p>
          </div>
        </div>

        <!-- OTP Verification Form -->
        <div id="otpForm" class="hidden">
          <div class="form-group">
            <label class="form-label" for="otp">Enter Verification Code</label>
            <input 
              type="text" 
              id="otp" 
              class="form-input" 
              placeholder="Enter 6-digit OTP"
              maxlength="6"
              pattern="[0-9]{6}"
              required
            >
            <small class="text-secondary">Enter the 6-digit code sent to your phone</small>
          </div>

          <button type="button" onclick="verifyOTP()" class="btn w-full mb-3" id="verifyOtpBtn">
            <span id="verifyOtpText">Verify OTP</span>
            <span id="verifyOtpLoading" class="loading hidden"></span>
          </button>

          <div class="text-center">
            <button type="button" onclick="resendOTP()" class="btn btn-secondary" id="resendBtn">
              Resend OTP
            </button>
            <p class="text-secondary mt-2">Didn't receive the code? Check your SMS or try resending.</p>
          </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden text-center">
          <div style="color: var(--primary-color); font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
          <h2>Welcome to CropPulse!</h2>
          <p class="text-secondary mb-3">You've successfully signed in. Redirecting to your dashboard...</p>
          <div class="loading"></div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
          <strong>Error:</strong> <span id="errorText"></span>
        </div>

        <!-- Features Preview -->
        <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
          <h4 class="text-center mb-3">What you'll get access to:</h4>
          <div class="grid grid-2" style="gap: 1rem;">
            <div class="text-center">
              <span style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;">üöÅ</span>
              <small>Drone Scanning</small>
            </div>
            <div class="text-center">
              <span style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;">ü§ñ</span>
              <small>AI Analysis</small>
            </div>
            <div class="text-center">
              <span style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;">üí¨</span>
              <small>Smart Chatbot</small>
            </div>
            <div class="text-center">
              <span style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;">üìä</span>
              <small>Real-time Reports</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="mailto:thecroppulse@gmail.com">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
      </div>
      <p>&copy; 2024 CropPulse. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyXXXXXXX",
      authDomain: "croppulse-12345.firebaseapp.com",
      projectId: "croppulse-12345",
      storageBucket: "croppulse-12345.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcd1234"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let confirmationResult = null;
    let recaptchaVerifier = null;

    // Initialize reCAPTCHA
    function initializeRecaptcha() {
      if (!recaptchaVerifier) {
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'invisible',
          'callback': function(response) {
            console.log('reCAPTCHA solved');
          },
          'expired-callback': function() {
            console.log('reCAPTCHA expired');
          }
        });
      }
    }

    // Send OTP function
    async function sendOTP() {
      const phoneNumber = document.getElementById('phone').value.trim();
      const sendOtpBtn = document.getElementById('sendOtpBtn');
      const sendOtpText = document.getElementById('sendOtpText');
      const sendOtpLoading = document.getElementById('sendOtpLoading');
      const errorMessage = document.getElementById('errorMessage');

      // Validate phone number
      if (!phoneNumber || phoneNumber.length < 10) {
        showError('Please enter a valid phone number');
        return;
      }

      try {
        // Show loading state
        sendOtpBtn.disabled = true;
        sendOtpText.classList.add('hidden');
        sendOtpLoading.classList.remove('hidden');
        errorMessage.classList.add('hidden');

        // Initialize reCAPTCHA
        initializeRecaptcha();

        // Send OTP
        const appVerifier = recaptchaVerifier;
        confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
        
        // Show OTP form
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        
        // Start countdown for resend
        startResendCountdown();

      } catch (error) {
        console.error('Error sending OTP:', error);
        showError('Failed to send OTP. Please try again.');
      } finally {
        // Reset button state
        sendOtpBtn.disabled = false;
        sendOtpText.classList.remove('hidden');
        sendOtpLoading.classList.add('hidden');
      }
    }

    // Verify OTP function
    async function verifyOTP() {
      const otp = document.getElementById('otp').value.trim();
      const verifyOtpBtn = document.getElementById('verifyOtpBtn');
      const verifyOtpText = document.getElementById('verifyOtpText');
      const verifyOtpLoading = document.getElementById('verifyOtpLoading');

      if (!otp || otp.length !== 6) {
        showError('Please enter a valid 6-digit OTP');
        return;
      }

      try {
        // Show loading state
        verifyOtpBtn.disabled = true;
        verifyOtpText.classList.add('hidden');
        verifyOtpLoading.classList.remove('hidden');

        // Verify OTP
        const result = await confirmationResult.confirm(otp);
        
        // Success - redirect to dashboard
        document.getElementById('otpForm').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 2000);

      } catch (error) {
        console.error('Error verifying OTP:', error);
        showError('Invalid OTP. Please try again.');
      } finally {
        // Reset button state
        verifyOtpBtn.disabled = false;
        verifyOtpText.classList.remove('hidden');
        verifyOtpLoading.classList.add('hidden');
      }
    }

    // Resend OTP function
    async function resendOTP() {
      const phoneNumber = document.getElementById('phone').value.trim();
      const resendBtn = document.getElementById('resendBtn');
      
      try {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending...';
        
        const appVerifier = recaptchaVerifier;
        confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
        
        showSuccess('OTP sent successfully!');
        startResendCountdown();
        
      } catch (error) {
        console.error('Error resending OTP:', error);
        showError('Failed to resend OTP. Please try again.');
      } finally {
        resendBtn.disabled = false;
      }
    }

    // Start countdown for resend button
    function startResendCountdown() {
      const resendBtn = document.getElementById('resendBtn');
      let countdown = 60;
      
      resendBtn.disabled = true;
      resendBtn.textContent = `Resend in ${countdown}s`;
      
      const timer = setInterval(() => {
        countdown--;
        resendBtn.textContent = `Resend in ${countdown}s`;
        
        if (countdown <= 0) {
          clearInterval(timer);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Resend OTP';
        }
      }, 1000);
    }

    // Show error message
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        errorMessage.classList.add('hidden');
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      // You can implement a success toast here
      console.log('Success:', message);
    }

    // Format phone number input
    document.getElementById('phone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 0 && !value.startsWith('+')) {
        value = '+91' + value;
      }
      e.target.value = value;
    });

    // Auto-focus on OTP input when form is shown
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const otpForm = document.getElementById('otpForm');
          if (!otpForm.classList.contains('hidden')) {
            document.getElementById('otp').focus();
          }
        }
      });
    });
    
    observer.observe(document.getElementById('otpForm'), {
      attributes: true,
      attributeFilter: ['class']
    });
  </script>
</body>
</html>